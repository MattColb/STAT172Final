elderly = sum(ELDERLY),
education = sum(EDUC),
<<<<<<< Updated upstream
married = sum(MARRIED)
) %>% ungroup()
#Non-included variables (Not in ACS):
#EMPSTAT, DIFFANY, VETSTAT
head(cps_data)
sum(cps_data$hhsize)
cps_data <- cps_data %>%
mutate(FSSTATUS = ifelse(FSSTATUS %in% c(98,99), NA, FSSTATUS),
FSSTATUSMD = ifelse(FSSTATUSMD %in% c(98,99), NA, FSSTATUSMD),
FSFOODS = ifelse(FSFOODS %in% c(98,99), NA, FSFOODS),
FSWROUTY = ifelse(FSWROUTY %in% c(96,97,98,99), NA, FSWROUTY),
FSBAL = ifelse(FSBAL %in% c(96,97,98,99), NA, FSBAL),
FSRAWSCRA = ifelse(FSRAWSCRA %in% c(98,99), NA, FSRAWSCRA),
FSTOTXPNC = ifelse(FSTOTXPNC %in% c(999), NA, FSTOTXPNC),
FSSTMPVALC = ifelse(FSSTMPVALC %in% c(996, 997, 998, 999), NA, FSSTMPVALC)) %>% #The 1000 wasn't in given code, but was always an outlier
mutate(FSSTATUS = ifelse(FSSTATUS > 1, 1, 0),
FSSTATUSMD = ifelse(FSSTATUSMD >1, 1, 0),
FSFOODS = ifelse(FSFOODS > 1, 1, 0),
FSWROUTY = ifelse(FSWROUTY > 1, 1, 0),
FSBAL = ifelse(FSBAL > 1, 1, 0),
FSRAWSCRA = ifelse(FSRAWSCRA >1, 1, 0),
FSTOTXPNC_perpers = ifelse(is.na(FSTOTXPNC), NA, FSTOTXPNC_perpers)
)
summary(cps_data)
str(cps_data)
head(cps_data)
ggplot(data=cps_data) +
geom_point(aes(x=hhsize, y=FSTOTXPNC_perpers))
ggplot(data=cps_data) +
geom_point(aes(x=kids, y=FSTOTXPNC_perpers))
ggplot(data=cps_data) +
geom_point(aes(x=elderly, y=FSTOTXPNC_perpers))
ggplot(data=cps_data, aes(x=kids, y=hhsize)) +
geom_count(aes(color=after_stat(n)))
ggplot(data=filter(cps_data, kids==0)) +
geom_point(aes(x=hhsize, y=FSTOTXPNC_perpers))
#FORWARD REGRESSION (IMPROVE):
remove_na = filter(cps_data, !is.na(cps_data$FSWROUTY))
m1 = glm(FSWROUTY ~ hhsize + married + education + elderly + kids + black + hispanic + female,
data=remove_na,
weights = weight,
family = binomial(link="logit"))
m0 = glm(FSWROUTY ~ 1,
data=remove_na,
weights = weight,
family = binomial(link="logit"))
v1 = step(m0, scope=list(lower = m0, upper=m1, direction="both"))
summary(v1)
remove_na = filter(cps_data, !is.na(cps_data$FSWROUTY))
m1 = glm(FSWROUTY ~ hhsize + married + education + elderly + kids + black +
hispanic + female + county + state,
data=remove_na,
weights = weight,
family = binomial(link="logit"))
=======
married = sum(MARRIED),
weight = weight[1])
head(acs_data)
map_chr(acs, ~attr(.x, "label")) %>%
bind_cols(names=names(acs), question = .) %>%
rownames_to_column(var="Variable Name") %>% kable
>>>>>>> Stashed changes
rm(list=ls())
library(tidyverse)
library(knitr)
library(tibble)
library(ggthemes)
library(logistf)
library(glmnet)
library(haven)
cps <- read.csv("./data/cps_00005.csv")
head(cps[,c("CPSID","PERNUM", "FSSTATUS", "FSSTATUSMD", "RACE","EDUC")]) %>% kable
<<<<<<< Updated upstream
#https://cps.ipums.org/cps-action/variables/search
=======
>>>>>>> Stashed changes
summary(cps)
#map_chr(cps, ~attr(.x, "label")) %>%
#  bind_cols(names=names(cps), question = .) %>%
#  rownames_to_column(var="Variable Name") %>% kable
cps <- cps %>% mutate(SEX = SEX-1,
CHILD = ifelse(AGE < 18, 1, 0),
<<<<<<< Updated upstream
ELDERLY = ifelse(AGE > 59, 1, 0),
=======
ELDERLY = ifelse(AGE > 64, 1, 0),
>>>>>>> Stashed changes
BLACK = ifelse(RACE==200, 1, 0),
HISPANIC = ifelse(HISPAN>0,1,0),
EDUC = as.integer(EDUC %in% c(91 ,92, 111, 123, 124, 125)),
EMP = as.integer(EMPSTAT%in% c(1,10,12)),
MARRIED = as.integer(MARST %in% c(1,2)),
DIFF = ifelse(DIFFANY==2,1,0),
COUNT = as.factor(COUNTY)
)
#Not currently grouping properly
cps_data <- cps %>% group_by(CPSID=as.factor(CPSID)) %>%
summarise(
COUNTY = first(COUNTY),
weight = first(HWTFINL),
hhsize = n(),
#Y variables
#All should be the same for each person in the household
#Search for more info about vars here: https://cps.ipums.org/cps-action/variables/search
FSTOTXPNC_perpers = first(FSTOTXPNC)/hhsize, #Different from packet, but needed for summary
FSSTATUS = first(FSSTATUS),
FSSTATUSMD = first(FSSTATUSMD),
FSFOODS = first(FSFOODS),
FSWROUTY = first(FSWROUTY),
FSBAL = first(FSBAL),
FSRAWSCRA = first(FSRAWSCRA),
FSTOTXPNC = first(FSTOTXPNC),
<<<<<<< Updated upstream
FSSTMPVALC = first(FSSTMPVALC),
=======
>>>>>>> Stashed changes
#FSSTATUS = first(FSSTATUS),
#FSTMPVALC, FSRAWSCRM,
female = sum(SEX),
hispanic = sum(HISPANIC),
black = sum(BLACK),
kids = sum(CHILD),
elderly = sum(ELDERLY),
education = sum(EDUC),
married = sum(MARRIED)
) %>% ungroup()
<<<<<<< Updated upstream
#Non-included variables (Not in ACS):
#EMPSTAT, DIFFANY, VETSTAT
=======
>>>>>>> Stashed changes
head(cps_data)
sum(cps_data$hhsize)
cps_data <- cps_data %>%
mutate(FSSTATUS = ifelse(FSSTATUS %in% c(98,99), NA, FSSTATUS),
FSSTATUSMD = ifelse(FSSTATUSMD %in% c(98,99), NA, FSSTATUSMD),
FSFOODS = ifelse(FSFOODS %in% c(98,99), NA, FSFOODS),
FSWROUTY = ifelse(FSWROUTY %in% c(96,97,98,99), NA, FSWROUTY),
FSBAL = ifelse(FSBAL %in% c(96,97,98,99), NA, FSBAL),
FSRAWSCRA = ifelse(FSRAWSCRA %in% c(98,99), NA, FSRAWSCRA),
<<<<<<< Updated upstream
FSTOTXPNC = ifelse(FSTOTXPNC %in% c(999), NA, FSTOTXPNC),
FSSTMPVALC = ifelse(FSSTMPVALC %in% c(996, 997, 998, 999), NA, FSSTMPVALC)) %>% #The 1000 wasn't in given code, but was always an outlier
=======
FSTOTXPNC = ifelse(FSTOTXPNC %in% c(999), NA, FSTOTXPNC)) %>% #The 1000 wasn't in given code, but was always an outlier
>>>>>>> Stashed changes
mutate(FSSTATUS = ifelse(FSSTATUS > 1, 1, 0),
FSSTATUSMD = ifelse(FSSTATUSMD >1, 1, 0),
FSFOODS = ifelse(FSFOODS > 1, 1, 0),
FSWROUTY = ifelse(FSWROUTY > 1, 1, 0),
FSBAL = ifelse(FSBAL > 1, 1, 0),
FSRAWSCRA = ifelse(FSRAWSCRA >1, 1, 0),
FSTOTXPNC_perpers = ifelse(is.na(FSTOTXPNC), NA, FSTOTXPNC_perpers)
<<<<<<< Updated upstream
)
=======
) #Are these really how we should be handling these variables?
>>>>>>> Stashed changes
summary(cps_data)
str(cps_data)
head(cps_data)
# ---- INFO ABOUT Y VARIABLES ----
#FSSTATUS:
#98 - No response, 99 - NIU (Not In Universe?), 01 - Food Secure, 02 - Low food secure, 03 - Very low food secure
#https://cps.ipums.org/cps-action/variables/FSSTATUS#codes_section
#FSSTATUS identifies the 12-month food security status of the household.
#FSSTATUSMD:
#98 - No response, 99 - NIU (Not In Universe?), 01 - High Food Secure, 02 - Marginal food security, 03 - Low food secure, 04 - Very low food secure
#https://cps.ipums.org/cps-action/variables/FSSTATUSMD#codes_section
#FSSTATUSMD identifies the detailed food security status of the household over the past 30 days.
#FSFOOD:
#96 - Refused, 97 - Don't Know, 98 - No response, 99 - NIU (Not In Universe?),
#01 - Enough and food they want, 02 - Enough not always what is wanted,
#03 - Sometimes not enough to eat, 04 - Often not enough to eat
#https://cps.ipums.org/cps-action/variables/FSFOODS#codes_section
#FSFOODS indicates whether the household had enough to eat or enough of the kinds of foods they wanted to eat in the past twelve months.
#FSWROUTY:
#96 - Refused, 97 - Don't Know, 98 - No response, 99 - NIU (Not In Universe?),
#01 - Never true, 02 - Sometimes true, 03 - Often true
#https://cps.ipums.org/cps-action/variables/FSWROUTY#codes_section
#FSWROUTY indicates if, in the past year, the household was worried that they would run out of food and not be able to afford more
#FSBAL:
#96 - Refused, 97 - Don't Know, 98 - No response, 99 - NIU (Not In Universe?),
#01 - Never true, 02 - Sometimes true, 03 - Often true
#https://cps.ipums.org/cps-action/variables/FSBAL#codes_section
#FSBAL indicates whether or not the respondent(s) could not afford to eat balanced meals at any time in the last 12 months
#FSRAWSCRA:
#00 - No responses/didn't pass screening, 98 - No response, 99 - NIU (Not In Universe?),
#01-10 - number of affirmitive answers given
#https://cps.ipums.org/cps-action/variables/FSRAWSCRA#description_section
#FSRAWSCRA reports the total number of affirmative answers the household provided to the 10 item household/adult food security questionnaire
#FSTOTXPNC:
#https://cps.ipums.org/cps-action/variables/FSTOTXPNC#description_section
#FSTOTXPNC indicates the total amount the household spent on food last week.
ggplot(data=cps_data) +
geom_point(aes(x=hhsize, y=FSTOTXPNC_perpers))
ggplot(data=cps_data) +
geom_point(aes(x=kids, y=FSTOTXPNC_perpers))
ggplot(data=cps_data) +
geom_point(aes(x=elderly, y=FSTOTXPNC_perpers))
ggplot(data=cps_data, aes(x=kids, y=hhsize)) +
geom_count(aes(color=after_stat(n)))
ggplot(data=filter(cps_data, kids==0)) +
geom_point(aes(x=hhsize, y=FSTOTXPNC_perpers))
<<<<<<< Updated upstream
#PREDICTIVE VARIABLES
#hhsize, married, education, elderly, kids, black, hispanic, female, county(?)
#FOCUS Y VARIABLES:
#FSWROUTY - Phuong
#Binary snap no snap FSSTMPVALC - Matt
#FSFOODS - Aria
#FORWARD REGRESSION (IMPROVE):
remove_na = filter(cps_data, !is.na(cps_data$FSWROUTY))
m1 = glm(FSWROUTY ~ hhsize + married + education + elderly + kids + black +
hispanic + female + county + state,
data=remove_na,
weights = weight,
family = binomial(link="logit"))
remove_na = filter(cps_data, !is.na(cps_data$FSWROUTY))
m1 = glm(FSWROUTY ~ hhsize + married + education + elderly + kids + black +
hispanic + female + COUNTY + state,
data=remove_na,
weights = weight,
family = binomial(link="logit"))
remove_na = filter(cps_data, !is.na(cps_data$FSWROUTY))
m1 = glm(FSWROUTY ~ hhsize + married + education + elderly + kids + black +
hispanic + female + COUNTY + STATE,
data=remove_na,
weights = weight,
family = binomial(link="logit"))
remove_na = filter(cps_data, !is.na(cps_data$FSWROUTY))
m1 = glm(FSWROUTY ~ hhsize + married + education + elderly + kids + black +
hispanic + female + COUNTY,
data=remove_na,
weights = weight,
family = binomial(link="logit"))
m0 = glm(FSWROUTY ~ 1,
data=remove_na,
weights = weight,
family = binomial(link="logit"))
v1 = step(m0, scope=list(lower = m0, upper=m1, direction="both"))
summary(v1)
=======
ggplot(data=cps_data, aes(x=kids, y=hhsize)) +
geom_count(aes(color=after_stat(n)))
full_model ~ lm(FSWROOUTY ~., data - cps)
step_model <- step(full_model, direction = "both")
full_model <- lm(FSWROOUTY ~., data - cps)
full_model <- lm(FSWROOUTY ~., data = cps)
full_model <- lm(FSWROUTY ~., data = cps)
step_model <- step(full_model, direction = "both")
summary(step_model)
full_model <- glm(FSWROUTY ~., data = cps)
step_model <- step(full_model, direction = "both")
summary(step_model)
full_model <- glm(FSWROUTY ~., data = cps, weights = weight, family = binomial(link = "logit")
step_model <- step(full_model, direction = "both")
>>>>>>> Stashed changes
#clean FSFOODS analysis file
rm(list=ls())
library(tidyverse)
library(knitr)
library(tibble)
library(ggthemes)
library(logistf)
library(glmnet)
library(haven)
library(pROC)
library(RColorBrewer)
library(randomForest)
source("./code/clean_cps.R")
source("./code/clean_acs.R")
#Cleaning and Exploring
summary(cps_data)
str(cps_data)
head(cps_data)
cps_data_f <- cps_data[!is.na(cps_data$FSFOODS),]
#Split the data into train/test df forms to use in lasso/ridge later
RNGkind(sample.kind = "default")
set.seed(26473)
train.idx <- sample(x = 1:nrow(cps_data_f), size = .7*nrow(cps_data_f))
train.df <- cps_data_f[train.idx,]
test.df <- cps_data_f[-train.idx,]
lr_mle_fsfoods <- glm(FSFOODS ~ hhsize + married + education + elderly +
kids + black + hispanic + female,
data=train.df,
family=binomial(link="logit"),
weights=weight
)
# Get warnings - algorithm did not converge, complete separation occurred
summary(lr_mle_fsfoods) #grossly high standard error on alll vars
#look at the coefficients from the MLE logistic regression
beta <- lr_mle_fsfoods %>% coef()
#----Lasso and Ridge with Basic X vars----
## Make all necessary matrices and vectors
fsfoods.x.train <- model.matrix(FSFOODS~hhsize + married + education + elderly +
kids + black + hispanic + female,
data = train.df)[,-1]
fsfoods.x.test <- model.matrix(FSFOODS~hhsize + married + education + elderly +
kids + black + hispanic + female,
data = test.df)[,-1]
fsfoods.y.train <- train.df$FSFOODS %>% as.vector()
fsfoods.y.test <- test.df$FSFOODS %>% as.vector()
train.weights <- as.vector(train.df$weight)
test.weights <- as.vector(test.df$weight) #not strictly necessary, for ease of reference
#Use cross validation to get tuning info for final regression
fsfoods_lasso_cv <- cv.glmnet(fsfoods.x.train, #MATRIX without our Y COLUMN
fsfoods.y.train, #VECTOR - our Y COLUMN
family = binomial(link = "logit"),
alpha = 1 #1 for lasso, 0 for ridge
)
#clean FSFOODS analysis file
rm(list=ls())
source("./code/clean_cps.R")
rlang::last_trace()
library(dplyr)
source("./code/clean_cps.R")
cps_data_f <- cps_data[!is.na(cps_data$FSFOODS),]
summary(cps_data_f$FSFOODS) #new subset without NAs has 6665 obs, compared to 8420 originally
summary(cps_data_f)
#Split the data into train/test df forms to use in lasso/ridge later
RNGkind(sample.kind = "default")
set.seed(26473)
train.idx <- sample(x = 1:nrow(cps_data_f), size = .7*nrow(cps_data_f))
train.df <- cps_data_f[train.idx,]
test.df <- cps_data_f[-train.idx,]
lr_mle_fsfoods <- glm(FSFOODS ~ hhsize + married + education + elderly +
kids + black + hispanic + female,
data=train.df,
family=binomial(link="logit"),
weights=weight
)
cps_data <- cps_data %>% mutate(
faminc_cleaned = case_when(faminc == 843 ~ 150000,
faminc == 830 ~ 60000,
faminc == 100 ~ 0,
faminc == 730 ~ 35000,
faminc == 842 ~ 100000,
faminc == 300 ~ 7500,
faminc == 720 ~ 30000,
faminc == 740 ~ 40000,
faminc == 710 ~ 25000,
faminc == 841 ~ 75000,
faminc == 600 ~ 20000,
faminc == 500 ~ 15000,
faminc == 820 ~ 50000,
faminc == 430 ~ 10000,
faminc == 210 ~ 50000,
faminc == 470 ~ 12500,
TRUE ~ NA)
)
rlang::last_trace()
source("~/GitHub/STAT172Final/code/clean_cps.R")
rm(list=ls())
library(tidyverse)
library(knitr)
library(tibble)
library(ggthemes)
library(logistf)
library(glmnet)
library(haven)
library(pROC)
library(RColorBrewer)
library(randomForest)
cps <- read.csv("./data/cps_00006.csv")
head(cps[,c("CPSID","PERNUM", "FSSTATUS", "FSSTATUSMD", "RACE","EDUC")]) %>% kable
summary(cps)
cps <- cps %>% mutate(SEX = SEX-1,
CHILD = ifelse(AGE < 18, 1, 0),
ELDERLY = ifelse(AGE > 59, 1, 0),
BLACK = ifelse(RACE==200, 1, 0),
HISPANIC = ifelse(HISPAN>0,1,0),
EDUC = as.integer(EDUC %in% c(91 ,92, 111, 123, 124, 125)),
EMP = as.integer(EMPSTAT%in% c(1,10,12)),
MARRIED = as.integer(MARST %in% c(1,2)),
DIFF = ifelse(DIFFANY==2,1,0),
COUNT = as.factor(COUNTY)
)
#Not currently grouping properly
cps_data <- cps %>% group_by(CPSID=as.factor(CPSID)) %>%
summarise(
county = first(COUNTY),
weight = first(HWTFINL),
hhsize = n(),
#Y variables
#All should be the same for each person in the household
#Search for more info about vars here: https://cps.ipums.org/cps-action/variables/search
FSTOTXPNC_perpers = first(FSTOTXPNC)/hhsize, #Different from packet, but needed for summary
FSSTATUS = first(FSSTATUS),
FSSTATUSMD = first(FSSTATUSMD),
FSFOODS = first(FSFOODS),
FSWROUTY = first(FSWROUTY),
FSBAL = first(FSBAL),
FSRAWSCRA = first(FSRAWSCRA),
FSTOTXPNC = first(FSTOTXPNC),
FSSTMPVALC = first(FSSTMPVALC),
#FSSTATUS = first(FSSTATUS),
#FSTMPVALC, FSRAWSCRM,
female = sum(SEX),
hispanic = sum(HISPANIC),
black = sum(BLACK),
kids = sum(CHILD),
elderly = sum(ELDERLY),
education = sum(EDUC),
married = sum(MARRIED),
faminc = first(FAMINC),
donut = ifelse(hhsize == (elderly+kids), 1, 0)
) %>% ungroup()
cps_data <- cps_data %>% mutate(
faminc_cleaned = case_when(faminc == 843 ~ 150000,
faminc == 830 ~ 60000,
faminc == 100 ~ 0,
faminc == 730 ~ 35000,
faminc == 842 ~ 100000,
faminc == 300 ~ 7500,
faminc == 720 ~ 30000,
faminc == 740 ~ 40000,
faminc == 710 ~ 25000,
faminc == 841 ~ 75000,
faminc == 600 ~ 20000,
faminc == 500 ~ 15000,
faminc == 820 ~ 50000,
faminc == 430 ~ 10000,
faminc == 210 ~ 50000,
faminc == 470 ~ 12500,
TRUE ~ NA)
)
str(cps_data)
head(cps_data)
summary(cps_data)
rm(list=ls())
library(tidyverse)
library(knitr)
library(tibble)
library(ggthemes)
library(logistf)
library(glmnet)
library(haven)
library(pROC)
library(RColorBrewer)
library(randomForest)
cps <- read.csv("./data/cps_00006.csv")
head(cps[,c("CPSID","PERNUM", "FSSTATUS", "FSSTATUSMD", "RACE","EDUC")]) %>% kable
#https://cps.ipums.org/cps-action/variables/search
summary(cps)
#map_chr(cps, ~attr(.x, "label")) %>%
#  bind_cols(names=names(cps), question = .) %>%
#  rownames_to_column(var="Variable Name") %>% kable
#Using lower bound estimates for FAMINC
cps <- cps %>% mutate(SEX = SEX-1,
CHILD = ifelse(AGE < 18, 1, 0),
ELDERLY = ifelse(AGE > 59, 1, 0),
BLACK = ifelse(RACE==200, 1, 0),
HISPANIC = ifelse(HISPAN>0,1,0),
EDUC = as.integer(EDUC %in% c(91 ,92, 111, 123, 124, 125)),
EMP = as.integer(EMPSTAT%in% c(1,10,12)),
MARRIED = as.integer(MARST %in% c(1,2)),
DIFF = ifelse(DIFFANY==2,1,0),
COUNT = as.factor(COUNTY)
)
#Not currently grouping properly
cps_data <- cps %>% group_by(CPSID=as.factor(CPSID)) %>%
summarise(
county = first(COUNTY),
weight = first(HWTFINL),
hhsize = n(),
#Y variables
#All should be the same for each person in the household
#Search for more info about vars here: https://cps.ipums.org/cps-action/variables/search
FSTOTXPNC_perpers = first(FSTOTXPNC)/hhsize, #Different from packet, but needed for summary
FSSTATUS = first(FSSTATUS),
FSSTATUSMD = first(FSSTATUSMD),
FSFOODS = first(FSFOODS),
FSWROUTY = first(FSWROUTY),
FSBAL = first(FSBAL),
FSRAWSCRA = first(FSRAWSCRA),
FSTOTXPNC = first(FSTOTXPNC),
FSSTMPVALC = first(FSSTMPVALC),
#FSSTATUS = first(FSSTATUS),
#FSTMPVALC, FSRAWSCRM,
female = sum(SEX),
hispanic = sum(HISPANIC),
black = sum(BLACK),
kids = sum(CHILD),
elderly = sum(ELDERLY),
education = sum(EDUC),
married = sum(MARRIED),
faminc = first(FAMINC),
donut = ifelse(hhsize == (elderly+kids), 1, 0)
) %>% ungroup()
cps_data <- cps_data %>% mutate(
faminc_cleaned = case_when(faminc == 843 ~ 150000,
faminc == 830 ~ 60000,
faminc == 100 ~ 0,
faminc == 730 ~ 35000,
faminc == 842 ~ 100000,
faminc == 300 ~ 7500,
faminc == 720 ~ 30000,
faminc == 740 ~ 40000,
faminc == 710 ~ 25000,
faminc == 841 ~ 75000,
faminc == 600 ~ 20000,
faminc == 500 ~ 15000,
faminc == 820 ~ 50000,
faminc == 430 ~ 10000,
faminc == 210 ~ 50000,
faminc == 470 ~ 12500,
TRUE ~ NA)
)
