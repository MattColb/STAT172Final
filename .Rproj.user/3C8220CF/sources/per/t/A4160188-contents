rm(list=ls())

library(tidyverse)
library(knitr)
library(tibble)
library(ggthemes)
library(logistf)
library(glmnet)
library(haven)

cps <- read.csv("./data/cps_00005.csv")
head(cps[,c("CPSID","PERNUM", "FSSTATUS", "FSSTATUSMD", "RACE","EDUC")]) %>% kable

#https://cps.ipums.org/cps-action/variables/search

summary(cps)

#map_chr(cps, ~attr(.x, "label")) %>% 
#  bind_cols(names=names(cps), question = .) %>%
#  rownames_to_column(var="Variable Name") %>% kable

cps <- cps %>% mutate(SEX = SEX-1,
                      CHILD = ifelse(AGE < 18, 1, 0),
                      ELDERLY = ifelse(AGE > 59, 1, 0),
                      BLACK = ifelse(RACE==200, 1, 0),
                      HISPANIC = ifelse(HISPAN>0,1,0),
                      EDUC = as.integer(EDUC %in% c(91 ,92, 111, 123, 124, 125)),
                      EMP = as.integer(EMPSTAT%in% c(1,10,12)),
                      MARRIED = as.integer(MARST %in% c(1,2)),
                      DIFF = ifelse(DIFFANY==2,1,0),
                      COUNT = as.factor(COUNTY)
                      )

#Not currently grouping properly
cps_data <- cps %>% group_by(CPSID=as.factor(CPSID)) %>%
  summarise(
    COUNTY = first(COUNTY),
    weight = first(HWTFINL),
    hhsize = n(),
    
    #Y variables
    #All should be the same for each person in the household
    #Search for more info about vars here: https://cps.ipums.org/cps-action/variables/search
    FSTOTXPNC_perpers = first(FSTOTXPNC)/hhsize, #Different from packet, but needed for summary
    FSSTATUS = first(FSSTATUS),
    FSSTATUSMD = first(FSSTATUSMD),
    FSFOODS = first(FSFOODS),
    FSWROUTY = first(FSWROUTY),
    FSBAL = first(FSBAL),
    FSRAWSCRA = first(FSRAWSCRA),
    FSTOTXPNC = first(FSTOTXPNC),
    #FSSTATUS = first(FSSTATUS),
    
    #FSTMPVALC, FSRAWSCRM, 
    
    female = sum(SEX),
    hispanic = sum(HISPANIC),
    black = sum(BLACK),
    kids = sum(CHILD),
    elderly = sum(ELDERLY),
    education = sum(EDUC),
    married = sum(MARRIED)
  ) %>% ungroup()

#Non-included variables:
#EMPSTAT, DIFFANY, VETSTAT

head(cps_data)
sum(cps_data$hhsize)

cps_data <- cps_data %>% 
  mutate(FSSTATUS = ifelse(FSSTATUS %in% c(98,99), NA, FSSTATUS),
         FSSTATUSMD = ifelse(FSSTATUSMD %in% c(98,99), NA, FSSTATUSMD),
         FSFOODS = ifelse(FSFOODS %in% c(98,99), NA, FSFOODS),
         FSWROUTY = ifelse(FSWROUTY %in% c(96,97,98,99), NA, FSWROUTY),
         FSBAL = ifelse(FSBAL %in% c(96,97,98,99), NA, FSBAL),
         FSRAWSCRA = ifelse(FSRAWSCRA %in% c(98,99), NA, FSRAWSCRA),
         FSTOTXPNC = ifelse(FSTOTXPNC %in% c(999), NA, FSTOTXPNC)) %>% #The 1000 wasn't in given code, but was always an outlier
  mutate(FSSTATUS = ifelse(FSSTATUS > 1, 1, 0),
         FSSTATUSMD = ifelse(FSSTATUSMD >1, 1, 0),
         FSFOODS = ifelse(FSFOODS > 1, 1, 0),
         FSWROUTY = ifelse(FSWROUTY > 1, 1, 0),
         FSBAL = ifelse(FSBAL > 1, 1, 0),
         FSRAWSCRA = ifelse(FSRAWSCRA >1, 1, 0),
         FSTOTXPNC_perpers = ifelse(is.na(FSTOTXPNC), NA, FSTOTXPNC_perpers)
  ) #Are these really how we should be handling these variables?



summary(cps_data)
str(cps_data)
head(cps_data)

# ---- INFO ABOUT Y VARIABLES ----

#FSSTATUS: 
#98 - No response, 99 - NIU (Not In Universe?), 01 - Food Secure, 02 - Low food secure, 03 - Very low food secure 
#https://cps.ipums.org/cps-action/variables/FSSTATUS#codes_section
#FSSTATUS identifies the 12-month food security status of the household. 

#FSSTATUSMD: 
#98 - No response, 99 - NIU (Not In Universe?), 01 - High Food Secure, 02 - Marginal food security, 03 - Low food secure, 04 - Very low food secure
#https://cps.ipums.org/cps-action/variables/FSSTATUSMD#codes_section
#FSSTATUSMD identifies the detailed food security status of the household over the past 30 days.

#FSFOOD: 
#96 - Refused, 97 - Don't Know, 98 - No response, 99 - NIU (Not In Universe?), 
#01 - Enough and food they want, 02 - Enough not always what is wanted, 
#03 - Sometimes not enough to eat, 04 - Often not enough to eat
#https://cps.ipums.org/cps-action/variables/FSFOODS#codes_section
#FSFOODS indicates whether the household had enough to eat or enough of the kinds of foods they wanted to eat in the past twelve months.

#FSWROUTY: 
#96 - Refused, 97 - Don't Know, 98 - No response, 99 - NIU (Not In Universe?), 
#01 - Never true, 02 - Sometimes true, 03 - Often true
#https://cps.ipums.org/cps-action/variables/FSWROUTY#codes_section
#FSWROUTY indicates if, in the past year, the household was worried that they would run out of food and not be able to afford more

#FSBAL: 
#96 - Refused, 97 - Don't Know, 98 - No response, 99 - NIU (Not In Universe?), 
#01 - Never true, 02 - Sometimes true, 03 - Often true
#https://cps.ipums.org/cps-action/variables/FSBAL#codes_section
#FSBAL indicates whether or not the respondent(s) could not afford to eat balanced meals at any time in the last 12 months

#FSRAWSCRA: 
#00 - No responses/didn't pass screening, 98 - No response, 99 - NIU (Not In Universe?), 
#01-10 - number of affirmitive answers given
#https://cps.ipums.org/cps-action/variables/FSRAWSCRA#description_section
#FSRAWSCRA reports the total number of affirmative answers the household provided to the 10 item household/adult food security questionnaire

#FSTOTXPNC:
#https://cps.ipums.org/cps-action/variables/FSTOTXPNC#description_section
#FSTOTXPNC indicates the total amount the household spent on food last week.

#VETSTAT:
#VETSTAT is a dichotomous variable identifying veterans, that is, persons who served in the military 
#forces of the United States (Army, Navy, Air Force, Marine Corps, or Coast Guard) 
#in time of war or peace, but who were not in the armed forces at the time of the survey. 

ggplot(data=cps_data) + 
  geom_point(aes(x=hhsize, y=FSTOTXPNC_perpers))

ggplot(data=cps_data) + 
  geom_point(aes(x=kids, y=FSTOTXPNC_perpers))

ggplot(data=cps_data) + 
  geom_point(aes(x=elderly, y=FSTOTXPNC_perpers))

ggplot(data=cps_data, aes(x=kids, y=hhsize)) + 
  geom_count(aes(color=after_stat(n)))

ggplot(data=filter(cps_data, kids==0)) + 
  geom_point(aes(x=hhsize, y=FSTOTXPNC_perpers))

#PREDICTIVE VARIABLES
#hhsize, married, education, elderly, kids, black, hispanic, female, county(?)

#FOCUS Y VARIABLES:
#FSWROUTY
#Binary snap no snap
#FSFOODS

#FORWARD REGRESSION:
